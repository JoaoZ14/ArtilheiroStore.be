<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0f0f12">
  <title>Admin â€“ Artilheiro Store</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --bg: #0f0f12;
      --surface: #1a1a1f;
      --surface-2: #222228;
      --border: #2d2d35;
      --text: #e8e8ed;
      --text-2: #b8b8c0;
      --muted: #6b6b75;
      --accent: #d4a82b;
      --accent-hover: #e0b83d;
      --accent-soft: rgba(212, 168, 43, 0.15);
      --success: #2e7d32;
      --success-soft: rgba(46, 125, 50, 0.2);
      --error: #c62828;
      --error-soft: rgba(198, 40, 40, 0.2);
      --touch: 44px;
      --radius: 10px;
      --radius-sm: 8px;
      --safe-bottom: env(safe-area-inset-bottom, 0);
      --safe-top: env(safe-area-inset-top, 0);
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 15px;
      line-height: 1.4;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      padding-bottom: var(--safe-bottom);
    }

    .layout { max-width: 900px; margin: 0 auto; padding: 0 16px; padding-top: var(--safe-top); }

    /* Header: compacto no mobile */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 0;
      margin: 0 -16px;
      padding-left: 16px;
      padding-right: 16px;
    }
    header h1 { font-size: 1.15rem; font-weight: 600; margin: 0; color: var(--accent); }

    /* Tabs: full-width no mobile, touch-friendly */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 16px 0 20px;
      padding: 4px;
      background: var(--surface);
      border-radius: var(--radius);
    }
    .tabs button {
      flex: 1;
      min-height: var(--touch);
      padding: 0 12px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-2);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s, color .15s;
    }
    .tabs button:hover { color: var(--text); background: var(--surface-2); }
    .tabs button.active { background: var(--accent); color: var(--bg); }

    .panel { display: none; }
    .panel.active { display: block; padding-bottom: 24px; }

    /* Cards de lista: mobile-first (sempre cards no mobile) */
    .list-cards { display: flex; flex-direction: column; gap: 10px; }
    .card-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      min-height: var(--touch);
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: inherit;
    }
    .card-row:active { background: var(--surface-2); }
    .card-row-main { flex: 1; min-width: 0; }
    .card-row-title { font-weight: 500; margin: 0 0 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-row-meta { font-size: 0.85rem; color: var(--muted); }
    .card-row-actions { flex-shrink: 0; }

    /* Tabela: sÃ³ em telas maiores */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table-wrap table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .table-wrap th, .table-wrap td { text-align: left; padding: 14px 12px; border-bottom: 1px solid var(--border); }
    .table-wrap th { color: var(--muted); font-weight: 500; font-size: 0.8rem; }
    .table-wrap tr:last-child td { border-bottom: none; }
    .table-wrap .mobile-only { display: none; }
    .table-wrap thead { position: sticky; top: 0; z-index: 10; background: var(--bg); box-shadow: 0 1px 0 var(--border); }
    .table-wrap tbody tr { cursor: pointer; transition: background .12s; }
    .table-wrap tbody tr:hover { background: var(--surface-2); }
    .table-wrap tbody tr:focus-within { outline: 2px solid var(--accent); outline-offset: -2px; }
    .order-code-cell { font-weight: 600; color: var(--accent); display: flex; align-items: center; gap: 6px; }
    .order-code-cell span { flex: 1; min-width: 0; }
    .btn-copy { min-height: 32px; padding: 0 8px; background: transparent; border: none; border-radius: var(--radius-sm); color: var(--text-2); cursor: pointer; transition: color .15s, background .15s; flex-shrink: 0; }
    .btn-copy:hover { color: var(--accent); background: var(--accent-soft); }
    .btn-copy:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    /* BotÃµes */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: var(--touch);
      padding: 0 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s, opacity .15s;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: var(--bg); }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
    .btn-secondary { background: var(--surface-2); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover:not(:disabled) { background: var(--border); }
    .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .btn-block { width: 100%; }
    .btn-sm { min-height: 36px; padding: 0 14px; font-size: 0.85rem; }

    /* FormulÃ¡rio */
    .form-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-card h2 { margin: 0 0 20px; font-size: 1.1rem; }
    .field { margin-bottom: 16px; }
    .field:last-of-type { margin-bottom: 0; }
    label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 500; color: var(--text-2); }
    input[type="text"], input[type="number"], input[type="datetime-local"], select {
      width: 100%;
      min-height: var(--touch);
      padding: 0 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 16px; /* evita zoom no iOS */
    }
    input:focus-visible, select:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    input[type="file"] { margin-top: 6px; font-size: 0.9rem; color: var(--text-2); }
    input[type="checkbox"] { width: 18px; height: 18px; margin-right: 8px; vertical-align: middle; }
    .form-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .form-actions .btn { flex: 1; min-width: 120px; }

    /* Grid de campos: 1 col mobile, 2 cols desktop */
    .form-grid { display: grid; gap: 16px; }
    @media (min-width: 480px) { .form-grid { grid-template-columns: 1fr 1fr; } }

    .sizes-block .detail-block-title { margin-bottom: 4px; font-size: 0.85rem; }
    .size-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
    .size-row input[type="text"] { flex: 0 0 80px; min-height: 40px; padding: 0 10px; }
    .size-row input[type="number"] { flex: 0 0 70px; min-height: 40px; padding: 0 10px; }
    .size-row .btn-remove-size { flex-shrink: 0; min-height: 40px; min-width: 40px; padding: 0; border-radius: var(--radius-sm); background: var(--surface-2); color: var(--text-2); border: 1px solid var(--border); cursor: pointer; font-size: 1.2rem; line-height: 1; transition: background .15s, color .15s; }
    .size-row .btn-remove-size:hover { background: var(--error-soft); color: var(--error); }
    .sizes-block .btn-add-size { margin-top: 8px; min-height: 36px; padding: 0 14px; font-size: 0.9rem; }

    /* Mensagens */
    .msg { margin-top: 16px; padding: 12px 14px; border-radius: var(--radius-sm); font-size: 0.9rem; }
    .msg.success { background: var(--success-soft); color: #81c784; }
    .msg.error { background: var(--error-soft); color: #e57373; }

    /* Badge status */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    /* Status: early â†’ amarelo, entregue â†’ verde, cancelado â†’ vermelho, envio â†’ Ã¢mbar */
    .badge-received, .badge-confirmed, .badge-preparing { background: rgba(212, 168, 43, 0.35); color: #e0b83d; }
    .badge-shipped, .badge-in-transit { background: rgba(230, 81, 0, 0.25); color: #ffb74d; }
    .badge-delivered { background: var(--success-soft); color: #81c784; }
    .badge-cancelled { background: var(--error-soft); color: #e57373; }

    .empty { text-align: center; padding: 40px 20px; color: var(--muted); font-size: 0.95rem; }

    /* Skeleton loading */
    .skeleton { background: linear-gradient(90deg, var(--surface-2) 25%, var(--border) 50%, var(--surface-2) 75%); background-size: 200% 100%; animation: skeleton 1.2s ease-in-out infinite; border-radius: 4px; }
    @keyframes skeleton { to { background-position: 200% 0; } }
    .skeleton-row td { padding: 14px 10px; }
    .skeleton-row td span { display: block; height: 16px; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn .spinner { margin-right: 8px; }

    /* Toast */
    .toast-container { position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 8px; max-width: 90vw; width: 360px; pointer-events: none; }
    .toast { padding: 14px 18px; border-radius: var(--radius-sm); font-size: 0.9rem; font-weight: 500; box-shadow: 0 4px 20px rgba(0,0,0,0.4); pointer-events: auto; animation: toastIn .25s ease; }
    .toast.success { background: var(--success); color: #fff; }
    .toast.error { background: var(--error); color: #fff; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Detail modal: blocos */
    .detail-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .detail-header h3 { margin: 0; font-size: 1.15rem; }
    .detail-block { margin-bottom: 24px; }
    .detail-block:last-of-type { margin-bottom: 0; }
    .detail-block-title { font-size: 0.8rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .04em; margin-bottom: 10px; }
    .detail-item { display: flex; align-items: center; gap: 14px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .detail-item:last-child { border-bottom: none; }
    .detail-item-thumb { width: 52px; height: 52px; border-radius: var(--radius-sm); background: var(--surface-2); object-fit: cover; flex-shrink: 0; }
    .detail-item-body { flex: 1; min-width: 0; }
    .detail-item-name { font-weight: 500; margin: 0 0 2px; }
    .detail-item-meta { font-size: 0.85rem; color: var(--muted); }
    .detail-item-price { font-weight: 500; white-space: nowrap; }
    .detail-summary { padding: 16px; background: var(--surface-2); border-radius: var(--radius-sm); font-weight: 600; font-size: 1.05rem; }

    /* Produtos: thumbnail, estoque */
    .product-thumb { width: 40px; height: 40px; border-radius: 6px; background: var(--surface-2); object-fit: cover; }
    .stock-low { color: var(--error); font-weight: 500; }
    .cell-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    /* Carrossel de imagens do produto */
    .product-carousel { margin-bottom: 20px; }
    .product-carousel-inner { position: relative; border-radius: var(--radius); overflow: hidden; background: var(--surface-2); aspect-ratio: 4/3; max-height: 280px; min-height: 200px; }
    .product-carousel-inner .carousel-slide { position: absolute; inset: 0; opacity: 0; transition: opacity .25s; pointer-events: none; display: flex; align-items: center; justify-content: center; }
    .product-carousel-inner .carousel-slide.active { opacity: 1; pointer-events: auto; }
    .product-carousel-inner .carousel-slide img { width: 100%; height: 100%; object-fit: contain; display: block; }
    .product-carousel-nav { display: flex; align-items: center; justify-content: center; gap: 12px; margin-top: 10px; }
    .product-carousel-nav button { min-height: 36px; min-width: 36px; padding: 0; border: none; border-radius: 50%; background: var(--surface-2); color: var(--text); cursor: pointer; font-size: 1.2rem; line-height: 1; transition: background .15s, color .15s; }
    .product-carousel-nav button:hover { background: var(--accent-soft); color: var(--accent); }
    .product-carousel-nav button:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .product-carousel-dots { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; margin-top: 8px; }
    .product-carousel-dots button { width: 8px; height: 8px; padding: 0; border: none; border-radius: 50%; background: var(--border); cursor: pointer; transition: background .15s; }
    .product-carousel-dots button.active { background: var(--accent); }
    .product-carousel-dots button:hover { background: var(--text-2); }

    /* Modal: full-screen no mobile, centralizado no desktop */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 100;
      padding: 0;
    }
    .modal-overlay.open { display: flex; }
    @media (min-width: 500px) {
      .modal-overlay { align-items: center; padding: 16px; }
    }
    .modal {
      width: 100%;
      max-width: 440px;
      max-height: 92vh;
      max-height: 92dvh;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius) var(--radius) 0 0;
      padding: 20px;
      padding-bottom: calc(20px + var(--safe-bottom));
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 500px) {
      .modal { border-radius: var(--radius); max-height: 90vh; }
    }
    .modal h3 { margin: 0 0 20px; font-size: 1.05rem; }
    .modal .field { margin-bottom: 14px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; }

    /* Top bar da seÃ§Ã£o */
    .section-top { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .section-top h2 { margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-2); }

    /* Esconder tabela no mobile, mostrar cards; no desktop mostrar tabela */
    .products-cards, .orders-cards { display: block; }
    .products-table, .orders-table { display: none; }
    @media (min-width: 640px) {
      .products-cards, .orders-cards { display: none; }
      .products-table, .orders-table { display: block; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>Artilheiro Admin</h1>
    </header>

    <div class="tabs" role="tablist">
      <button type="button" class="tab-btn active" data-panel="pedidos" role="tab" aria-selected="true">Pedidos</button>
      <button type="button" class="tab-btn" data-panel="produtos" role="tab" aria-selected="false">Produtos</button>
    </div>

    <div id="panel-pedidos" class="panel active" role="tabpanel">
      <div class="section-top">
        <h2>Pedidos</h2>
      </div>
      <div id="pedidos-list"></div>
    </div>

    <div id="panel-produtos" class="panel" role="tabpanel" hidden>
      <div class="section-top">
        <h2>Produtos</h2>
        <button type="button" class="btn btn-primary" id="btn-novo-produto">+ Novo</button>
      </div>
      <div id="produtos-list"></div>
      <div class="form-card" id="card-form-produto" style="display: none;">
        <h2 id="form-produto-title">Novo produto</h2>
        <div id="product-carousel-wrap" class="product-carousel" style="display: none;" aria-label="Fotos do produto">
          <div class="product-carousel-inner" id="product-carousel-inner"></div>
          <div class="product-carousel-nav" id="product-carousel-nav">
            <button type="button" id="carousel-prev" aria-label="Foto anterior">â€¹</button>
            <span id="carousel-counter">1 / 1</span>
            <button type="button" id="carousel-next" aria-label="PrÃ³xima foto">â€º</button>
          </div>
          <div class="product-carousel-dots" id="product-carousel-dots"></div>
        </div>
        <form id="form-produto">
          <input type="hidden" id="produto-id" name="id" />
          <div class="form-grid">
            <div class="field">
              <label for="name">Nome *</label>
              <input type="text" id="name" name="name" required placeholder="Ex: Camisa Flamengo 24/25" />
            </div>
            <div class="field">
              <label for="team">Time *</label>
              <input type="text" id="team" name="team" required placeholder="Ex: Flamengo" />
            </div>
          </div>
          <div class="form-grid">
            <div class="field">
              <label for="liga">Liga *</label>
              <input type="text" id="liga" name="liga" required placeholder="Ex: BrasileirÃ£o" />
            </div>
            <div class="field">
              <label for="category">Categoria *</label>
              <input type="text" id="category" name="category" required placeholder="Ex: Camisa" />
            </div>
          </div>
          <div class="form-grid">
            <div class="field">
              <label for="price">PreÃ§o *</label>
              <input type="number" id="price" name="price" step="0.01" min="0.01" required placeholder="199,90" inputmode="decimal" />
            </div>
            <div class="field">
              <label for="promoPrice">PreÃ§o promocional (opcional)</label>
              <input type="number" id="promoPrice" name="promoPrice" step="0.01" min="0.01" placeholder="Ex: 149,90" inputmode="decimal" />
              <span class="field-hint">Se preenchido, exibe em promoÃ§Ã£o mantendo o preÃ§o principal</span>
            </div>
          </div>
          <div class="field sizes-block">
            <div class="detail-block-title">Tamanhos / Estoque *</div>
            <p class="field-hint" style="margin-bottom: 10px;">Adicione cada tamanho e a quantidade em estoque.</p>
            <div id="sizes-list"></div>
            <button type="button" class="btn btn-secondary btn-add-size" id="btn-add-size">+ Adicionar tamanho</button>
          </div>
          <div class="field">
            <label><input type="checkbox" id="active" name="active" checked /> Ativo</label>
          </div>
          <div class="field">
            <label for="images">Imagens (opcional)</label>
            <input type="file" id="images" name="images" accept="image/jpeg,image/png,image/webp" multiple />
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="btn-cancel-produto">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btn-submit-produto">Salvar</button>
          </div>
        </form>
        <div id="msg-produto"></div>
      </div>
    </div>

    <div id="modal-pedido" class="modal-overlay" aria-hidden="true">
      <div class="modal">
        <div class="detail-header">
          <h3>Pedido <span id="modal-pedido-codigo"></span></h3>
          <span id="modal-pedido-status-badge" class="badge"></span>
        </div>
        <div id="modal-pedido-content">
          <div class="detail-block" id="modal-pedido-itens">
            <div class="detail-block-title">Itens do pedido</div>
            <div id="modal-pedido-itens-list"></div>
          </div>
          <div class="detail-block">
            <div class="detail-block-title">Resumo financeiro</div>
            <div class="detail-summary" id="modal-pedido-total"></div>
          </div>
        </div>
        <form id="form-pedido">
          <div class="detail-block">
            <div class="detail-block-title">Alterar status e envio</div>
            <input type="hidden" id="pedido-id" />
            <div class="field">
              <label for="pedido-status">Status</label>
              <select id="pedido-status" name="status">
                <option value="RECEIVED">Recebido</option>
                <option value="CONFIRMED">Confirmado</option>
                <option value="PREPARING">Em preparaÃ§Ã£o</option>
                <option value="SHIPPED">Enviado</option>
                <option value="IN_TRANSIT">Em trÃ¢nsito</option>
                <option value="DELIVERED">Entregue</option>
                <option value="CANCELLED">Cancelado</option>
              </select>
            </div>
            <div class="field">
              <label for="pedido-shippedAt">Data de envio</label>
              <input type="datetime-local" id="pedido-shippedAt" name="shippedAt" />
            </div>
            <div class="field">
              <label for="pedido-carrier">Transportadora</label>
              <input type="text" id="pedido-carrier" name="carrier" placeholder="Ex: Correios" />
            </div>
            <div class="field">
              <label for="pedido-trackingCode">CÃ³digo de rastreio</label>
              <input type="text" id="pedido-trackingCode" name="trackingCode" placeholder="Ex: BR123456789" />
            </div>
            <div class="field">
              <label for="pedido-trackingUrl">Link de rastreio</label>
              <input type="text" id="pedido-trackingUrl" name="trackingUrl" placeholder="https://..." inputmode="url" />
            </div>
            <div class="modal-actions">
              <button type="button" class="btn btn-secondary" id="btn-fechar-pedido">Fechar</button>
              <button type="submit" class="btn btn-primary">Salvar alteraÃ§Ãµes</button>
            </div>
          </div>
        </form>
        <div id="msg-pedido"></div>
      </div>
    </div>
  </div>
  <div id="toast-container" class="toast-container" aria-live="polite"></div>

  <script>
    const API_PRODUCTS = '/api/products';
    const API_ORDERS = '/api/orders';

    function renderSizesRows(sizes) {
      const list = document.getElementById('sizes-list');
      list.innerHTML = '';
      const entries = sizes && typeof sizes === 'object' && Object.keys(sizes).length > 0
        ? Object.entries(sizes)
        : [['', 0]];
      entries.forEach(([size, qty]) => {
        const row = document.createElement('div');
        row.className = 'size-row';
        row.innerHTML = `
          <input type="text" class="size-label" placeholder="Ex: P" value="${escapeHtml(size)}" maxlength="20" aria-label="Tamanho" />
          <input type="number" class="size-qty" min="0" step="1" value="${Number(qty) || 0}" aria-label="Quantidade" />
          <button type="button" class="btn-remove-size" aria-label="Remover tamanho">Ã—</button>
        `;
        list.appendChild(row);
      });
      list.querySelectorAll('.btn-remove-size').forEach(btn => {
        btn.addEventListener('click', () => {
          const row = btn.closest('.size-row');
          const rows = list.querySelectorAll('.size-row');
          if (rows.length > 1) row.remove();
          else {
            row.querySelector('.size-label').value = '';
            row.querySelector('.size-qty').value = '0';
          }
        });
      });
    }

    function addSizeRow() {
      const list = document.getElementById('sizes-list');
      const row = document.createElement('div');
      row.className = 'size-row';
      row.innerHTML = `
        <input type="text" class="size-label" placeholder="Ex: GG" maxlength="20" aria-label="Tamanho" />
        <input type="number" class="size-qty" min="0" step="1" value="0" aria-label="Quantidade" />
        <button type="button" class="btn-remove-size" aria-label="Remover tamanho">Ã—</button>
      `;
      list.appendChild(row);
      row.querySelector('.btn-remove-size').addEventListener('click', () => {
        const rows = list.querySelectorAll('.size-row');
        if (rows.length > 1) row.remove();
      });
    }

    function getSizesFromForm() {
      const list = document.getElementById('sizes-list');
      const out = {};
      list.querySelectorAll('.size-row').forEach(row => {
        const label = (row.querySelector('.size-label').value || '').trim();
        const qty = parseInt(row.querySelector('.size-qty').value, 10);
        if (label) out[label] = isNaN(qty) || qty < 0 ? 0 : qty;
      });
      return out;
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function formatDateTime(s) {
      if (!s) return '-';
      try {
        const d = new Date(s);
        return isNaN(d.getTime()) ? s : d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch (_) { return s; }
    }

    function formatDate(s) {
      if (!s) return '-';
      try {
        const d = new Date(s);
        return isNaN(d.getTime()) ? s : d.toLocaleDateString('pt-BR');
      } catch (_) { return s; }
    }

    function formatPrice(n) {
      return 'R$ ' + Number(n).toFixed(2).replace('.', ',');
    }

    function showToast(message, type) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast ' + (type || 'success');
      toast.textContent = message;
      toast.setAttribute('role', 'alert');
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function statusBadgeClass(s) {
      const k = (s || '').toLowerCase().replace('_', '-');
      return 'badge badge-' + (k === 'cancelled' ? 'cancelled' : k === 'delivered' ? 'delivered' : k === 'shipped' || k === 'in-transit' ? 'shipped' : 'received');
    }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
        document.querySelectorAll('.panel').forEach(p => { p.classList.remove('active'); p.setAttribute('hidden', ''); });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        const panel = document.getElementById('panel-' + btn.dataset.panel);
        panel.classList.add('active');
        panel.removeAttribute('hidden');
        if (btn.dataset.panel === 'pedidos') loadPedidos();
        if (btn.dataset.panel === 'produtos') loadProdutos();
      });
    });

    function productStockTotal(p) {
      if (!p.sizes || typeof p.sizes !== 'object') return 0;
      return Object.values(p.sizes).reduce((a, n) => a + (Number(n) || 0), 0);
    }

    async function toggleProductActive(p, btnEl) {
      const newActive = !p.active;
      btnEl.disabled = true;
      try {
        const product = {
          name: p.name,
          team: p.team,
          liga: p.liga,
          category: p.category,
          price: p.price,
          promoPrice: p.promoPrice != null ? p.promoPrice : null,
          sizes: p.sizes,
          active: newActive
        };
        const formData = new FormData();
        formData.append('product', new Blob([JSON.stringify(product)], { type: 'application/json' }), 'product.json');
        const res = await fetch(API_PRODUCTS + '/' + p.id, { method: 'PUT', body: formData });
        if (res.ok) {
          showToast(newActive ? 'Produto ativado.' : 'Produto desativado.', 'success');
          loadProdutos();
        } else {
          const data = await res.json().catch(() => ({}));
          showToast(data.message || 'Erro ao atualizar. Tente novamente.', 'error');
        }
      } catch (err) {
        showToast('Erro ao atualizar. Tente novamente.', 'error');
      }
      btnEl.disabled = false;
    }

    // Produtos
    async function loadProdutos() {
      const el = document.getElementById('produtos-list');
      el.innerHTML = `
        <div class="products-table table-wrap">
          <table><thead><tr><th></th><th>Nome</th><th>Time</th><th>Categoria</th><th>PreÃ§o</th><th>Estoque</th><th>Status</th><th></th></tr></thead>
          <tbody>
            ${[1,2,3,4,5].map(() => '<tr class="skeleton-row"><td><span class="skeleton product-thumb"></span></td><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td></td></tr>').join('')}
          </tbody></table>
        </div>
      `;
      let list = [];
      try {
        const res = await fetch(API_PRODUCTS + '/admin');
        list = await res.json();
      } catch (_) {
        list = [];
      }
      if (!list.length) {
        el.innerHTML = '<p class="empty">Nenhum produto. Toque em + Novo para cadastrar.</p>';
        return;
      }
      const badge = (p) => p.active ? '<span class="badge badge-delivered">Ativo</span>' : '<span class="badge badge-cancelled">Inativo</span>';
      const thumb = (p) => (p.images && p.images[0]) ? `<img class="product-thumb" src="${escapeHtml(p.images[0])}" alt="" loading="lazy">` : '<div class="product-thumb" aria-hidden="true"></div>';
      el.innerHTML = `
        <div class="products-cards list-cards">
          ${list.map(p => {
            const stock = productStockTotal(p);
            return `
            <div class="card-row" role="button" tabindex="0" data-id="${p.id}" aria-label="Editar ${escapeHtml(p.name)}">
              <div class="card-row-main">
                <p class="card-row-title">${escapeHtml(p.name)} Â· ${escapeHtml(p.team)}</p>
                <p class="card-row-meta">${escapeHtml(p.category)} Â· ${formatPrice(p.price)} Â· Estoque: ${stock}${stock <= 2 ? ' (baixo)' : ''} Â· ${badge(p)}</p>
              </div>
              <div class="card-row-actions">
                <button type="button" class="btn btn-sm ${p.active ? 'btn-secondary btn-toggle-product' : 'btn-primary btn-toggle-product'}" data-id="${p.id}" data-active="${p.active}" aria-label="${p.active ? 'Desativar' : 'Ativar'}">${p.active ? 'Desativar' : 'Ativar'}</button>
                <button type="button" class="btn btn-secondary btn-sm btn-edit-produto" data-id="${p.id}">Editar</button>
              </div>
            </div>`;
          }).join('')}
        </div>
        <div class="products-table table-wrap">
          <table>
            <thead><tr><th></th><th>Nome</th><th>Time</th><th>Categoria</th><th>PreÃ§o</th><th>Estoque</th><th>Status</th><th></th></tr></thead>
            <tbody>
              ${list.map(p => {
                const stock = productStockTotal(p);
                const lowClass = stock <= 2 ? ' stock-low' : '';
                return `
                <tr role="button" tabindex="0" data-id="${p.id}">
                  <td>${thumb(p)}</td>
                  <td>${escapeHtml(p.name)}</td>
                  <td>${escapeHtml(p.team)}</td>
                  <td>${escapeHtml(p.category)}</td>
                  <td>${formatPrice(p.price)}</td>
                  <td class="${lowClass}">${stock}</td>
                  <td>${badge(p)}</td>
                  <td class="cell-actions">
                    <button type="button" class="btn btn-sm ${p.active ? 'btn-secondary' : 'btn-primary'} btn-toggle-product" data-id="${p.id}" data-active="${p.active}" aria-label="${p.active ? 'Desativar' : 'Ativar'}">${p.active ? 'Desativar' : 'Ativar'}</button>
                    <button type="button" class="btn btn-secondary btn-sm btn-edit-produto" data-id="${p.id}">Editar</button>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      const openProduct = (id) => {
        const p = list.find(x => x.id === id);
        if (p) openEditProduto(p);
      };
      el.querySelectorAll('.btn-edit-produto').forEach(b => {
        b.addEventListener('click', (e) => { e.stopPropagation(); openProduct(b.dataset.id); });
      });
      el.querySelectorAll('.btn-toggle-product').forEach(b => {
        b.addEventListener('click', (e) => {
          e.stopPropagation();
          const p = list.find(x => x.id === b.dataset.id);
          if (!p) return;
          toggleProductActive(p, b);
        });
      });
      el.querySelectorAll('.card-row[data-id]').forEach(row => {
        row.addEventListener('click', () => openProduct(row.dataset.id));
        row.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openProduct(row.dataset.id); } });
      });
      el.querySelectorAll('.products-table tbody tr[data-id]').forEach(row => {
        row.addEventListener('click', (e) => { if (!e.target.closest('button')) openProduct(row.dataset.id); });
        row.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openProduct(row.dataset.id); } });
      });
    }

    let productCarouselIndex = 0;
    let productCarouselImages = [];

    function renderProductCarousel(images) {
      productCarouselImages = images || [];
      const wrap = document.getElementById('product-carousel-wrap');
      const inner = document.getElementById('product-carousel-inner');
      const counter = document.getElementById('carousel-counter');
      const dotsEl = document.getElementById('product-carousel-dots');
      if (!productCarouselImages.length) {
        wrap.style.display = 'none';
        return;
      }
      wrap.style.display = 'block';
      inner.innerHTML = productCarouselImages.map((url, i) =>
        `<div class="carousel-slide${i === 0 ? ' active' : ''}" data-index="${i}" role="tabpanel" aria-label="Foto ${i + 1} de ${productCarouselImages.length}">
          <img src="${escapeHtml(url)}" alt="Foto do produto ${i + 1}" loading="lazy" />
        </div>`
      ).join('');
      dotsEl.innerHTML = productCarouselImages.map((_, i) =>
        `<button type="button" class="${i === 0 ? 'active' : ''}" data-index="${i}" aria-label="Ir para foto ${i + 1}" aria-selected="${i === 0}"></button>`
      ).join('');
      productCarouselIndex = 0;
      counter.textContent = `1 / ${productCarouselImages.length}`;
      dotsEl.querySelectorAll('button').forEach((btn, i) => {
        btn.addEventListener('click', () => goCarousel(i));
      });
    }

    function goCarousel(index) {
      const n = productCarouselImages.length;
      if (n === 0) return;
      productCarouselIndex = ((index % n) + n) % n;
      document.querySelectorAll('#product-carousel-inner .carousel-slide').forEach((el, i) => {
        el.classList.toggle('active', i === productCarouselIndex);
      });
      document.querySelectorAll('#product-carousel-dots button').forEach((el, i) => {
        el.classList.toggle('active', i === productCarouselIndex);
        el.setAttribute('aria-selected', i === productCarouselIndex);
      });
      document.getElementById('carousel-counter').textContent = `${productCarouselIndex + 1} / ${n}`;
    }

    function openEditProduto(p) {
      document.getElementById('form-produto-title').textContent = 'Editar produto';
      document.getElementById('produto-id').value = p.id;
      document.getElementById('name').value = p.name;
      document.getElementById('team').value = p.team;
      document.getElementById('liga').value = p.liga;
      document.getElementById('category').value = p.category;
      document.getElementById('price').value = p.price;
      document.getElementById('promoPrice').value = p.promoPrice != null ? p.promoPrice : '';
      renderSizesRows(p.sizes);
      document.getElementById('active').checked = p.active;
      document.getElementById('images').value = '';
      renderProductCarousel(p.images);
      document.getElementById('card-form-produto').style.display = 'block';
      document.getElementById('msg-produto').textContent = '';
      document.getElementById('card-form-produto').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    document.getElementById('btn-novo-produto').addEventListener('click', () => {
      document.getElementById('form-produto-title').textContent = 'Novo produto';
      document.getElementById('form-produto').reset();
      document.getElementById('produto-id').value = '';
      document.getElementById('active').checked = true;
      renderSizesRows(null);
      renderProductCarousel([]);
      document.getElementById('card-form-produto').style.display = 'block';
      document.getElementById('msg-produto').textContent = '';
      document.getElementById('card-form-produto').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    document.getElementById('carousel-prev').addEventListener('click', () => {
      if (productCarouselImages.length) goCarousel(productCarouselIndex - 1);
    });
    document.getElementById('carousel-next').addEventListener('click', () => {
      if (productCarouselImages.length) goCarousel(productCarouselIndex + 1);
    });

    document.getElementById('btn-cancel-produto').addEventListener('click', () => {
      document.getElementById('card-form-produto').style.display = 'none';
    });

    document.getElementById('btn-add-size').addEventListener('click', addSizeRow);

    document.getElementById('form-produto').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msgEl = document.getElementById('msg-produto');
      const btn = document.getElementById('btn-submit-produto');
      const id = document.getElementById('produto-id').value;
      const priceVal = document.getElementById('price').value.replace(',', '.');
      const price = parseFloat(priceVal);
      if (isNaN(price) || price <= 0) {
        msgEl.textContent = 'PreÃ§o invÃ¡lido.';
        msgEl.className = 'msg error';
        return;
      }
      const sizes = getSizesFromForm();
      if (Object.keys(sizes).length === 0) {
        msgEl.textContent = 'Adicione ao menos um tamanho com nome (ex: P, M, G) e quantidade.';
        msgEl.className = 'msg error';
        return;
      }
      const promoPriceVal = document.getElementById('promoPrice').value.trim().replace(',', '.');
      const promoPrice = promoPriceVal === '' ? null : (parseFloat(promoPriceVal) > 0 ? parseFloat(promoPriceVal) : null);
      const product = {
        name: document.getElementById('name').value.trim(),
        team: document.getElementById('team').value.trim(),
        liga: document.getElementById('liga').value.trim(),
        category: document.getElementById('category').value.trim(),
        price,
        promoPrice: promoPrice,
        sizes,
        active: document.getElementById('active').checked
      };
      btn.disabled = true;
      const btnText = btn.textContent.trim() || 'Salvar';
      btn.innerHTML = '<span class="spinner" aria-hidden="true"></span> Salvando...';
      msgEl.textContent = '';
      try {
        const files = document.getElementById('images').files;
        const formData = new FormData();
        formData.append('product', new Blob([JSON.stringify(product)], { type: 'application/json' }), 'product.json');
        for (let i = 0; i < files.length; i++) formData.append('images', files[i], files[i].name);
        const url = id ? API_PRODUCTS + '/' + id : API_PRODUCTS;
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, { method, body: formData });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          msgEl.textContent = id ? 'Produto atualizado.' : 'Produto cadastrado.';
          msgEl.className = 'msg success';
          showToast(id ? 'Produto salvo com sucesso.' : 'Produto cadastrado com sucesso.', 'success');
          loadProdutos();
          document.getElementById('card-form-produto').style.display = 'none';
        } else {
          msgEl.textContent = data.message || 'Erro ao salvar produto. Tente novamente.';
          msgEl.className = 'msg error';
          showToast(msgEl.textContent, 'error');
        }
      } catch (err) {
        msgEl.textContent = 'Erro ao salvar produto. Tente novamente.';
        msgEl.className = 'msg error';
        showToast(msgEl.textContent, 'error');
      }
      btn.disabled = false;
      btn.textContent = btnText;
    });

    // Pedidos
    async function loadPedidos() {
      const el = document.getElementById('pedidos-list');
      el.innerHTML = `
        <div class="orders-table table-wrap">
          <table><thead><tr><th>CÃ³digo</th><th>Data</th><th>Total</th><th>Status</th><th></th></tr></thead>
          <tbody>
            ${[1,2,3,4,5].map(() => '<tr class="skeleton-row"><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td><span class="skeleton"></span></td><td></td></tr>').join('')}
          </tbody></table>
        </div>
      `;
      let list = [];
      try {
        const res = await fetch(API_ORDERS + '/admin');
        list = await res.json();
      } catch (_) {
        list = [];
      }
      if (!list.length) {
        el.innerHTML = '<p class="empty">Nenhum pedido.</p>';
        return;
      }
      list.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
      const statusClass = (s) => statusBadgeClass(s);
      el.innerHTML = `
        <div class="orders-cards list-cards">
          ${list.map(o => `
            <div class="card-row" role="button" tabindex="0" data-id="${o.id}" aria-label="Pedido ${escapeHtml(o.orderCode)}">
              <div class="card-row-main">
                <p class="card-row-title">${escapeHtml(o.orderCode)}</p>
                <p class="card-row-meta">${formatDate(o.createdAt)} Â· ${formatPrice(o.total)} Â· <span class="${statusClass(o.status)}">${escapeHtml(o.status)}</span></p>
              </div>
              <div class="card-row-actions">
                <button type="button" class="btn btn-secondary btn-sm btn-gerir-pedido" data-id="${o.id}" aria-label="Ver detalhes">Ver detalhes</button>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="orders-table table-wrap">
          <table>
            <thead><tr><th>CÃ³digo</th><th>Data</th><th>Total</th><th>Status</th><th></th></tr></thead>
            <tbody>
              ${list.map(o => `
                <tr role="button" tabindex="0" data-id="${o.id}" data-order-code="${escapeHtml(o.orderCode)}">
                  <td class="order-code-cell">
                    <span>${escapeHtml(o.orderCode)}</span>
                    <button type="button" class="btn-copy" title="Copiar cÃ³digo" aria-label="Copiar cÃ³digo do pedido" data-code="${escapeHtml(o.orderCode)}">ðŸ“‹</button>
                  </td>
                  <td>${formatDate(o.createdAt)}</td>
                  <td>${formatPrice(o.total)}</td>
                  <td><span class="${statusClass(o.status)}">${escapeHtml(o.status)}</span></td>
                  <td><button type="button" class="btn btn-secondary btn-sm btn-gerir-pedido" data-id="${o.id}">Ver detalhes</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      const openOrder = (id) => {
        const o = list.find(x => x.id === id);
        if (o) openModalPedido(o);
      };
      el.querySelectorAll('.btn-gerir-pedido').forEach(b => {
        b.addEventListener('click', (e) => { e.stopPropagation(); openOrder(b.dataset.id); });
      });
      el.querySelectorAll('.btn-copy').forEach(b => {
        b.addEventListener('click', (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(b.dataset.code || '').then(() => showToast('CÃ³digo copiado.', 'success'));
        });
      });
      el.querySelectorAll('.card-row[data-id]').forEach(row => {
        row.addEventListener('click', () => openOrder(row.dataset.id));
        row.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openOrder(row.dataset.id); } });
      });
      el.querySelectorAll('.orders-table tbody tr[data-id]').forEach(row => {
        row.addEventListener('click', (e) => { if (!e.target.closest('button')) openOrder(row.dataset.id); });
        row.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openOrder(row.dataset.id); } });
      });
    }

    function openModalPedido(o) {
      document.getElementById('modal-pedido-codigo').textContent = o.orderCode;
      const badgeEl = document.getElementById('modal-pedido-status-badge');
      badgeEl.textContent = o.status || 'RECEIVED';
      badgeEl.className = 'badge ' + statusBadgeClass(o.status);
      document.getElementById('pedido-id').value = o.id;
      document.getElementById('pedido-status').value = o.status || 'RECEIVED';
      document.getElementById('pedido-shippedAt').value = o.shippedAt ? o.shippedAt.slice(0, 16) : '';
      document.getElementById('pedido-carrier').value = o.carrier || '';
      document.getElementById('pedido-trackingCode').value = o.trackingCode || '';
      document.getElementById('pedido-trackingUrl').value = o.trackingUrl || '';
      document.getElementById('msg-pedido').textContent = '';
      const items = o.items || [];
      document.getElementById('modal-pedido-itens-list').innerHTML = items.length ? items.map(it => {
        const img = (it.image || (it.images && it.images[0])) ? `<img class="detail-item-thumb" src="${escapeHtml(it.image || it.images[0])}" alt="" loading="lazy">` : '<div class="detail-item-thumb" style="background:var(--surface-2)" aria-hidden="true"></div>';
        const name = escapeHtml(it.name || 'Produto');
        const meta = [it.size, 'Qtd: ' + (it.quantity || 0)].filter(Boolean).join(' Â· ');
        const price = formatPrice(it.price);
        return `<div class="detail-item">${img}<div class="detail-item-body"><p class="detail-item-name">${name}</p><p class="detail-item-meta">${escapeHtml(meta)}</p></div><div class="detail-item-price">${price}</div></div>`;
      }).join('') : '<p class="empty" style="padding:12px 0">Nenhum item.</p>';
      document.getElementById('modal-pedido-total').textContent = 'Total: ' + formatPrice(o.total);
      document.getElementById('modal-pedido').classList.add('open');
      document.getElementById('modal-pedido').setAttribute('aria-hidden', 'false');
    }

    document.getElementById('btn-fechar-pedido').addEventListener('click', () => {
      document.getElementById('modal-pedido').classList.remove('open');
      document.getElementById('modal-pedido').setAttribute('aria-hidden', 'true');
    });

    document.getElementById('modal-pedido').addEventListener('click', (e) => {
      if (e.target.id === 'modal-pedido') {
        e.target.classList.remove('open');
        e.target.setAttribute('aria-hidden', 'true');
      }
    });

    document.getElementById('form-pedido').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('pedido-id').value;
      const msgEl = document.getElementById('msg-pedido');
      const shippedAt = document.getElementById('pedido-shippedAt').value;
      const payload = {
        status: document.getElementById('pedido-status').value,
        shippedAt: shippedAt ? shippedAt + ':00' : null,
        carrier: document.getElementById('pedido-carrier').value.trim() || null,
        trackingCode: document.getElementById('pedido-trackingCode').value.trim() || null,
        trackingUrl: document.getElementById('pedido-trackingUrl').value.trim() || null
      };
      try {
        const res = await fetch(API_ORDERS + '/' + id, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          msgEl.textContent = 'Status atualizado com sucesso.';
          msgEl.className = 'msg success';
          showToast('Status atualizado com sucesso.', 'success');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Salvar alteraÃ§Ãµes';
          loadPedidos();
          setTimeout(() => {
            document.getElementById('modal-pedido').classList.remove('open');
            document.getElementById('modal-pedido').setAttribute('aria-hidden', 'true');
          }, 600);
        } else {
          const data = await res.json().catch(() => ({}));
          msgEl.textContent = data.message || 'Erro ao atualizar. Tente novamente.';
          msgEl.className = 'msg error';
          showToast(msgEl.textContent, 'error');
        }
      } catch (err) {
        msgEl.textContent = 'Erro ao atualizar. Tente novamente.';
        msgEl.className = 'msg error';
        showToast(msgEl.textContent, 'error');
      }
      submitBtn.disabled = false;
      submitBtn.textContent = 'Salvar alteraÃ§Ãµes';
    });

    loadPedidos();
  </script>
</body>
</html>
